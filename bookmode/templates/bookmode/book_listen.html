{% extends "quiz/base.html" %}

{% block content %}

<style>


  /* Overall layout */
  .book-mode-wrapper {
    max-width: 900px;
    margin: 0 auto 2rem;
    padding: 0 1rem;
  }

  .stats-box {
    background: #f7f7fb;
    border-radius: 12px;
    padding: 1.2rem 1.5rem;
    box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    margin-bottom: 1rem;
  }

  .stats-box h2 {
    margin: 0 0 .4rem;
    font-size: 1.4rem;
  }

  .stats-box p {
    margin: 0;
    color: #555;
  }

  /* CATEGORY FILTER */
  .filter-bar {
    margin-top: .75rem;
    display: flex;
    flex-wrap: wrap;
    gap: .5rem;
    align-items: center;
  }

  .filter-bar label {
    font-size: .9rem;
    font-weight: 600;
    color: #333;
  }

  .filter-bar select {
    padding: .35rem .6rem;
    border-radius: 999px;
    border: 1px solid #ccc;
    font-size: .9rem;
    background: #fff;
  }

  .filter-bar button {
    border: none;
    border-radius: 999px;
    padding: .35rem .9rem;
    font-size: .85rem;
    cursor: pointer;
    background: #0d6efd;
    color: #fff;
    transition: background .15s ease, transform .1s ease;
  }

  .filter-bar button:hover {
    background: #0b5ed7;
    transform: translateY(-1px);
  }

  .quiz-block {
    background: #ffffff;
    border-radius: 12px;
    padding: 1.2rem 1.5rem 1.4rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }

  .question-header {
    margin-bottom: 1rem;
    gap: 1rem;
  }

  .question-header p {
    margin: 0;
    font-weight: 600;
    color: #333;
  }

  .play-buttons {
    display: flex;
    gap: .5rem;
    flex-wrap: wrap;
  }

  .reader-btn {
    border: none;
    padding: .5rem 1.1rem;
    border-radius: 999px;
    font-size: .95rem;
    cursor: pointer;
    background: #0d6efd;
    color: #fff;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: .25rem;
    transition: background .15s ease, transform .1s ease, box-shadow .15s ease;
    box-shadow: 0 2px 4px rgba(13,110,253,0.25);
    white-space: nowrap;
  }

  .reader-btn:hover {
    background: #0b5ed7;
    transform: translateY(-1px);
  }

  .reader-btn.pause-btn {
    background: #6c757d;
    box-shadow: 0 2px 4px rgba(108,117,125,0.3);
  }

  .reader-btn.pause-btn:hover {
    background: #5b636a;
  }

  /* Speed slider section */
  .speed-control {
    margin-top: .75rem;
    font-size: .9rem;
    color: #444;
  }

  .speed-control label {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: .25rem;
    font-weight: 600;
  }

  .speed-control span#tts-speed-value {
    font-weight: 700;
    color: #111;
  }

  .speed-control input[type="range"] {
    width: 100%;
  }

  #qa-counter {
    margin: .25rem 0 1rem;
    font-weight: 500;
    color: #444;
  }

  .qa-row {
    margin-bottom: .6rem;
  }

  .qa-row strong {
    display: inline-block;
    min-width: 110px;
  }

  .qa-row span {
    color: #222;
  }

  .quiz-actions {
    margin-top: 1.2rem;
    display: flex;
    flex-wrap: wrap;
    gap: .5rem;
  }

  .quiz-actions .btn {
    border-radius: 999px;
    padding: .45rem 1.1rem;
    border: none;
    font-size: .9rem;
    cursor: pointer;
    background: #0d6efd;
    color: #fff;
    transition: background .15s ease, transform .1s ease;
  }

  .quiz-actions .btn[name="action"][value="reset"] {
    background: #6c757d;
  }

  @media (max-width: 640px) {
    .question-header {
      flex-direction: column;
      align-items: flex-start;
    }
    .play-buttons {
      width: 100%;
    }
    .reader-btn {
      flex: 1 1 auto;
    }
    .quiz-actions .btn {
      flex: 1 1 30%;
    }
  }
    /* CATEGORY / SECTION FILTER */
  .filter-bar {
    margin-top: .75rem;
  }

  .filter-label {
    font-size: .9rem;
    font-weight: 600;
    color: #333;
    margin-bottom: .3rem;
  }

  .filter-controls {
    display: flex;
    flex-wrap: wrap;
    gap: .5rem;
    align-items: center;
  }

  .filter-select {
    flex: 1 1 180px;
    max-width: 260px;
    padding: .45rem .9rem;
    border-radius: 999px;
    border: 1px solid #ced4da;
    font-size: .9rem;
    background: #fff;
    box-shadow: 0 1px 2px rgba(0,0,0,0.04);
  }

  .filter-btn {
    border: none;
    border-radius: 999px;
    padding: .45rem 1.2rem;
    font-size: .85rem;
    cursor: pointer;
    background: #0d6efd;
    color: #fff;
    transition: background .15s ease, transform .1s ease, box-shadow .15s ease;
    box-shadow: 0 2px 4px rgba(13,110,253,0.25);
    white-space: nowrap;
  }

  .filter-btn:hover {
    background: #0b5ed7;
    transform: translateY(-1px);
  }

  @media (max-width: 640px) {
    .filter-controls {
      flex-direction: column;
      align-items: stretch;
    }
    .filter-select {
      max-width: 100%;
    }
    .filter-btn {
      width: 100%;
      text-align: center;
    }
  }

  
</style>

<div class="book-mode-wrapper">

  <div class="stats-box">
    <h2>Book listening mode</h2>
    {% if total > 0 %}
      <p id="stats-counter">Question {{ index }} of {{ total }}</p>
    {% else %}
      <p>No book-mode questions found yet.</p>
    {% endif %}

        <!-- CATEGORY FILTER -->
       <!-- SECTION FILTER -->
   <!-- SECTION FILTER (matches style with main UI) -->
<!-- SECTION FILTER -->
<form method="get" style="margin-top: 0.75rem;">
  <label for="section-select"
         style="font-size: 0.9rem;
                font-weight: 600;
                color: #333;
                display: block;
                margin-bottom: 0.25rem;">
    Section:
  </label>

  <div style="display: flex;
              flex-direction: column;
              gap: 0.4rem;
              max-width: 100%;">
    
    <select id="section-select"
            name="category"
            style="padding: 6px 10px;
                   font-size: 0.9rem;
                   border-radius: 6px;
                   border: 1px solid #ced4da;
                   width: 100%;
                   max-width: 100%;
                   box-sizing: border-box;
                   display: block;">
      <option value="">All sections</option>
      {% if categories %}
        {% for cat in categories %}
          <option value="{{ cat }}"
            {% if selected_category == cat %}selected{% endif %}>
            {{ cat|title }}
          </option>
        {% endfor %}
      {% else %}
        <option value="" disabled>(no sections set yet)</option>
      {% endif %}
    </select>

    <button type="submit"
            style="border: none;
                   border-radius: 999px;
                   padding: 0.4rem 1.1rem;
                   font-size: 0.85rem;
                   cursor: pointer;
                   background: #0d6efd;
                   color: #fff;
                   box-shadow: 0 2px 4px rgba(13,110,253,0.25);
                   white-space: nowrap;
                   align-self: flex-start;">
      Apply
    </button>
  </div>
</form>


    <!-- END SECTION FILTER -->


    <!-- END CATEGORY FILTER -->


  </div>

  {% if question %}
    <div class="quiz-block">

      <div class="question-header" style="display:flex; align-items:center; justify-content:space-between;">
        <p><strong>Listening:</strong> question and correct answer only</p>

        <div class="play-buttons">
          <button type="button" class="reader-btn" onclick="bookListenPlayCurrent()">üîä Play</button>
          <button type="button" class="reader-btn" onclick="bookListenPlayAll()">üîä Play All</button>
          <button type="button" class="reader-btn pause-btn" onclick="bookListenPause()">‚è∏ Pause</button>
        </div>
      </div>

      <!-- Speed slider -->
      <div class="speed-control">
        <label for="tts-speed">
          Speech speed
          <span id="tts-speed-value">1.4x</span>
        </label>
        <input type="range"
               id="tts-speed"
               min="0.5"
               max="3.0"
               step="0.1"
               value="1.4">
      </div>

      <p id="qa-counter">Question {{ index }} of {{ total }}</p>

      <p class="qa-row">
        <strong>Question:</strong>
        <span id="vis-question">{{ question.question_text|linebreaksbr }}</span>
      </p>
      <p class="qa-row">
        <strong>Correct answer:</strong>
        <span id="vis-answer">{{ question.correct_answer|linebreaksbr }}</span>
      </p>

      <form method="post" class="quiz-actions">
        {% csrf_token %}
        <!-- keep current category when navigating -->
        {% if selected_category %}
          <input type="hidden" name="category" value="{{ selected_category }}">
        {% endif %}
        <button class="btn" name="action" value="prev">‚¨Ö Previous</button>
        <button class="btn" name="action" value="next">Next ‚û°</button>
        <button class="btn" name="action" value="reset">üîÅ Reset to start</button>
      </form>

    </div>

    {{ all_questions|json_script:"all-qa-json" }}

    <script>
      const qaJsonEl = document.getElementById("all-qa-json");
      let qaList = qaJsonEl ? JSON.parse(qaJsonEl.textContent) : [];

      let currentIdx = Number("{{ index|default:1 }}") - 1;
      let autoPlaying = false;
      let currentAudio = null;

      // Speed slider
      let ttsSpeed = 1.4;
      const speedSlider = document.getElementById("tts-speed");
      const speedLabel  = document.getElementById("tts-speed-value");

      speedSlider.addEventListener("input", function() {
        ttsSpeed = parseFloat(this.value);
        speedLabel.textContent = ttsSpeed.toFixed(1) + "x";
      });

      function updateVisibleQA(i) {
        if (!qaList.length || i < 0 || i >= qaList.length) return;

        const q = qaList[i];
        document.getElementById("vis-question").innerHTML = q.question_text.replace(/\n/g, "<br>");
        document.getElementById("vis-answer").innerHTML   = q.correct_answer.replace(/\n/g, "<br>");

        document.getElementById("qa-counter").textContent =
          `Question ${i + 1} of ${qaList.length}`;

        document.getElementById("stats-counter").textContent =
          `Question ${i + 1} of ${qaList.length}`;
      }

      function playOne(idx, keepAuto) {
        if (!qaList.length) return;

        autoPlaying = !!keepAuto;

        if (currentAudio) {
          currentAudio.pause();
          currentAudio = null;
        }

        const q = qaList[idx];
        const text =
          `Question ${idx + 1}. ${q.question_text}. Correct answer: ${q.correct_answer}.`;

        const url =
          "/tts/?text=" + encodeURIComponent(text) +
          "&speed=" + encodeURIComponent(ttsSpeed.toFixed(2));

        const audio = new Audio(url);
        currentAudio = audio;

        audio.addEventListener("ended", function () {
          if (autoPlaying) {
            currentIdx++;
            if (currentIdx < qaList.length) {
              updateVisibleQA(currentIdx);
              playOne(currentIdx, true);
            } else {
              autoPlaying = false;
            }
          }
        });

        audio.play().catch(err => console.error("Audio play failed:", err));
      }

      function bookListenPlayCurrent() {
        if (!qaList.length) return;
        if (currentIdx < 0) currentIdx = 0;
        if (currentIdx >= qaList.length) currentIdx = qaList.length - 1;
        updateVisibleQA(currentIdx);
        playOne(currentIdx, false);
      }

      function bookListenPlayAll() {
        if (!qaList.length) return;
        if (currentIdx < 0 || currentIdx >= qaList.length)
          currentIdx = 0;

        updateVisibleQA(currentIdx);
        playOne(currentIdx, true);
      }

      function bookListenPause() {
        autoPlaying = false;
        if (currentAudio) currentAudio.pause();
      }

      window.bookListenPlayCurrent = bookListenPlayCurrent;
      window.bookListenPlayAll = bookListenPlayAll;
      window.bookListenPause = bookListenPause;
    </script>

  {% else %}
    <p>You don‚Äôt have any BookModeSession questions yet.</p>
  {% endif %}

</div>
{% endblock %}
