{% extends "quiz/base.html" %}

{% block content %}
<div class="stats-box">
  <h2>Book listening mode</h2>
  {% if total > 0 %}
    <p id="stats-counter">Question {{ index }} of {{ total }}</p>
  {% else %}
    <p>No book-mode questions found yet.</p>
  {% endif %}
</div>


{% if question %}
  <div class="quiz-block">

    <div class="question-header" style="display:flex; align-items:center; justify-content:space-between;">
      <p><strong>Listening:</strong> question and correct answer only</p>

      <!-- main play button (current question only) -->
      <button type="button"
              class="reader-btn"
              onclick="bookListenPlayCurrent()">
        üîä Play
      </button>

      <!-- play all questions with auto-advance -->
      <button type="button"
              class="reader-btn"
              onclick="bookListenPlayAll()">
        üîä Play All
      </button>
    </div>

    <p id="qa-counter">
      Question {{ index }} of {{ total }}
    </p>

    <p>
      <strong>Question:</strong>
      <span id="vis-question">{{ question.question_text|linebreaksbr }}</span>
    </p>
    <p>
      <strong>Correct answer:</strong>
      <span id="vis-answer">{{ question.correct_answer|linebreaksbr }}</span>
    </p>

    <form method="post" style="margin-top:15px;">
      {% csrf_token %}
      <button class="btn" name="action" value="prev" type="submit">‚¨Ö Previous</button>
      <button class="btn" name="action" value="next" type="submit">Next ‚û°</button>
      <button class="btn" name="action" value="reset" type="submit">üîÅ Reset to start</button>
    </form>

  </div>

  <!-- {# Dump all_questions into a hidden <script> as JSON #} -->
  {{ all_questions|json_script:"all-qa-json" }}

  <script>
    // Pull the questions from the JSON script tag
    const qaJsonEl = document.getElementById("all-qa-json");
    let qaList = [];
    if (qaJsonEl) {
      qaList = JSON.parse(qaJsonEl.textContent);
    }

    // currentIdx is 0-based; template index is 1-based
    let currentIdx = Number("{{ index|default:1 }}") - 1;
    let autoPlaying = false;
    let currentAudio = null;

    function updateVisibleQA(i) {
        if (!qaList.length || i < 0 || i >= qaList.length) return;

        const q = qaList[i];

        // Update the visible question / answer
        const qEl = document.getElementById("vis-question");
        const aEl = document.getElementById("vis-answer");
        const counterEl = document.getElementById("qa-counter");
        const statsCounterEl = document.getElementById("stats-counter");

        if (qEl) {
            qEl.innerHTML = (q.question_text || "").replace(/\n/g, "<br>");
        }
        if (aEl) {
            aEl.innerHTML = (q.correct_answer || "").replace(/\n/g, "<br>");
        }
        if (counterEl) {
            counterEl.textContent = `Question ${i + 1} of ${qaList.length}`;
        }
        if (statsCounterEl) {
            statsCounterEl.textContent = `Question ${i + 1} of ${qaList.length}`;
        }
     }


    function playOne(idx, keepAuto) {
      if (!qaList.length) return;
      if (idx < 0 || idx >= qaList.length) return;

      autoPlaying = !!keepAuto;

      // stop any previous audio
      if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
      }

      const q = qaList[idx];
      const text = `Question ${idx + 1}. ${q.question_text}. Correct answer: ${q.correct_answer}.`;
      const url = "/tts/?text=" + encodeURIComponent(text);

      const audio = new Audio(url);
      currentAudio = audio;

      audio.addEventListener("ended", function () {
        if (autoPlaying) {
          currentIdx++;
          if (currentIdx < qaList.length) {
            updateVisibleQA(currentIdx);
            playOne(currentIdx, true);  // play next
          } else {
            autoPlaying = false;  // finished all
          }
        }
      });

      audio.play().catch(err => {
        console.error("Audio play failed", err);
      });
    }

    // Play just the current question on screen
    function bookListenPlayCurrent() {
      if (!qaList.length) return;

      if (currentIdx < 0) currentIdx = 0;
      if (currentIdx >= qaList.length) currentIdx = qaList.length - 1;

      updateVisibleQA(currentIdx);
      playOne(currentIdx, false);
    }

    // Play ALL questions from the beginning, auto-advancing UI + counter
    function bookListenPlayAll() {
      if (!qaList.length) return;

      currentIdx = 0;
      updateVisibleQA(currentIdx);
      playOne(currentIdx, true);
    }

    // expose functions to the buttons
    window.bookListenPlayCurrent = bookListenPlayCurrent;
    window.bookListenPlayAll = bookListenPlayAll;
  </script>

  <!-- {# If you ever want auto-play on load, uncomment this and it will
     play the current question as soon as the page loads (after a user interaction on mobile): #}
  {#  -->
  <script>
    window.addEventListener('load', function () {
      bookListenPlayCurrent();
    });
  </script>


{% else %}
  <p>You don‚Äôt have any BookModeSession questions yet.</p>
{% endif %}
{% endblock %}
